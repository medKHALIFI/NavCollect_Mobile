<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
     <!-- jQuery -->
     <script src="plugins/jquery/dist/jquery.min.js"></script>
    <!-- Google Fonts & Materialize icon  -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet" type="text/css">
    <!-- Bootstrap -->
    <link href="plugins/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
    <!-- NProgress -->
    <link href="plugins/nprogress/nprogress.css" rel="stylesheet">
    <!-- jQuery custom content scroller -->
    <link href="plugins/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.min.css" rel="stylesheet" />
    <!-- Waves Effect Css -->
    <link href="plugins/node-waves/waves.css" rel="stylesheet" />
    <!-- Animation Css -->
    <link href="plugins/animate-css/animate.css" rel="stylesheet" />
    <!-- Sweet Alert 2 Plugin CSS & Js -->
    <link href="plugins/SweetAlert2/sweetalert2.min.css" rel="stylesheet" />
    <script src="plugins/SweetAlert2/sweetalert2.min.js"></script>
    <!-- Custom Theme Style -->
    <link href="css/custom.css" rel="stylesheet">
</head>

<body class="nav-md ">
    <div class="container body">
        <div class="main_container">
            <!-- top navigation -->
            <div class="navheader">
                <div class="col-sm-12" align="center">
                    <div class="row">
                        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4" style="margin-bottom: 10px"><img src="images/logo.png" alt="logo" style="width:110px; height:40px"></div>
                        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2"></div>
                        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2"></div>
                        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2"><button type="button" class="btn btn-circle bg-footer" onclick="go_data()"><i class="fas fa-database"></i></button></div>
                        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2"><button type="button" class="btn btn-circle bg-footer" onclick="go_home()"><i class="fas fa-map-marked-alt"></i></button></div>
                    </div>
                </div>
            </div>
            <br>
            <script>
                
                function save() {
                    console.log("projet ;" + id_projet_globale + " agent " + id_agent_globale + " zone " + id_zone_globale + " form " + id_zone_globale);

                    console.log("projet ;" + nom_projet + " agent " + nom_agent + " zone " + nom_zone + " form " + nom_form);
                    swal({
                        title: 'Êtes-vous sûr des données?',
                        text: "Vous ne pourrez pas revenir en arrière!",
                        type: 'success',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Confirmer'
                    }).then((result) => {
                        if (result.value) {
                            swal({
                                position: 'top-end',
                                type: 'success',
                                title: 'Le formulaire est bien remplis',
                                showConfirmButton: false,
                                timer: 1500
                            })
                            setTimeout(
                                function() {

                                    alert("quitte");
                                },
                            1000);
                        }
                    })
                }
            </script>
            <!-- /top navigation -->

            <!-- page content -->
            <div class="right_col" role="main">
                <div class="">
                    <div class="page-title">

                    </div>

                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h5>Remplissez votre formulaire</h5>
                                    <div class="clearfix"></div>
                                </div>

                                <div class="x_content">
                                    <div id="form_contenu"></div>
                                    <div class="row clearfix">
                                        <div class=".col-md-4 .col-md-offset-4">
                                            <div class="btn-group btn-group-justified" role="group" aria-label="...">
                                                <div class="btn-group" role="group">
                                                    <button id="refresh" class="float-right btn bg-red" type="button"><i class="fas fa-redo-alt"></i> &nbsp; Réinitialiser</button>
                                                </div>
                                                <div class="btn-group" role="group">
                                                    <button id="save_data" class="float-left btn bg-green" type="button"><i class="far fa-save"></i>&nbsp; Sauvegarder</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /page content -->
    </div>
    </div>

    <script type="text/javascript">

        function go_home() {
            url = 'index.html';
            location.replace(url);
        }
        function go_data() {
            url = 'data.html';
            location.replace(url);
        }
        function get_form() {
            $("#form_contenu").html(" ");

            var url = "http://192.168.0.118/php/get_form_html.php";
            $.getJSON(url, function(result) {
                //alert(result);

                $.each(result, function(i, field) {
                    var id_formulaire = field.id_formulaire;
                    var champs = field.champs;
                    if (id_form_globale == id_formulaire) {
                        $("#form_contenu").html(champs);
                    }
                });
            });
        }
    </script>
    <!-- get url-->
    <script type="text/javascript" src="js/geturi.js"></script>
    <script type="text/javascript">
        // les variable globale 
        var nom_agent;
        var nom_projet;
        var nom_zone;
        var nom_form;
        var data;
        var zone;
        var id_projet_globale = decodeURI(getUrlVars()["id_projet"]);
        var id_agent_globale = decodeURI(getUrlVars()["id_agent"]);
        var id_zone_globale = decodeURI(getUrlVars()["id_zone"]);
        var id_form_globale = decodeURI(getUrlVars()["id_form"]);
        var geojson = decodeURI(getUrlVars()["geojson"]);

        var url = "http://192.168.0.118/php/get_forms.php";
        $.getJSON(url, function(result) {
            
            $.each(result, function(i, field) {


                var id_projet_affect = field.id_projet_affect;
                var id_agent_affect = field.id_agent_affect;
                var id_formulaire_affect = field.id_formulaire_affect;
                var id_projet_zone = field.id_projet_zone;

                if (id_agent_affect == id_agent_globale && id_projet_affect == id_projet_globale && id_projet_zone == id_zone_globale && id_formulaire_affect == id_form_globale) {
                    nom_agent = field.nom_agent;
                    nom_projet = field.titre;
                    nom_zone = field.nom_zone;
                    nom_form = field.nom_form;

                    
                }
            });
        });

    </script>

    <!--save form-->
    <script>
        function saveForm() {
            console.log("resultat du formulaise sous form geojson");
            console.log(JSON.stringify($("#idform").serializeArray()));
            var data = JSON.stringify($("#idform").serializeArray());
            console.log("geojson de la couche : ", geojson)
                //   insert(nom_projet, nom_agent, nom_zone, nom_form, data, geojson);
            alert(nom_projet + "\n " + nom_agent + "\n " + nom_zone + "\n " + nom_form + "\n " + data + "\n " + geojson);
            save();
        }
    </script>
    <!-- Bootstrap -->
    <script src="plugins/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="plugins/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="plugins/nprogress/nprogress.js"></script>
    <!-- jQuery custom content scroller -->
    <script src="plugins/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="js/custom.js"></script>
    <!-- Waves Effect Plugin Js -->
    <script src="plugins/node-waves/waves.js"></script>
    <!-- Select Plugin Js -->
    <script src="plugins/bootstrap-select/js/bootstrap-select.js"></script>
    <!-- Cordova -->
    <script src="cordova.js"></script>

    <!-- sqlite -->
    <script>
        $(document).ready(function() {
            $("#save_data").click(function() {
                
                data = JSON.stringify($("#idform").serializeArray());
                
                swal({
                    title: 'Êtes-vous sûr des données?',
                    text: "Vous ne pourrez pas revenir en arrière!",
                    type: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Confirmer',
                    cancelButtonText:'annuler'
                }).then((result) => {
                    if (result.value) {
                        //Send to SQLIte database
                        myDB.transaction(function(transaction) {
                            var executeQuery = "INSERT INTO data (nom_projet,nom_agent,nom_zone ,nom_form ,data  ,zone ) VALUES (?,?,?,?,?,?)";
                            transaction.executeSql(executeQuery, [nom_projet, nom_agent, nom_zone, nom_form, data, geojson], function(tx, result) {
                                //  Message de succès
                                swal({
                                    position: 'center',
                                    type: 'success',
                                    title: 'Votre travail est sauvegardé',
                                    showConfirmButton: false,
                                    timer: 1500
                                });

                                $("#save_data").prop('disabled', true);
                            },
                            function(error) {
                                alert('Error occurred');
                            });
                        });
                        setTimeout(function() {
                            url = 'data.html';
                            location.replace(url);
                        }, 1500);
                    }
                })
            });

            $("#save_data").click(function(){
                $("#form_contenu").trigger("reset");
            });

            var myDB;
            //Open Database Connection
            document.addEventListener("deviceready", onDeviceReady, false);

            function onDeviceReady() {
                myDB = window.sqlitePlugin.openDatabase({
                    name: "mySQLite.db",
                    location: 'default'
                });

                //creation de la table 
                myDB.transaction(function(transaction) {
                    transaction.executeSql('CREATE TABLE IF NOT EXISTS data (id integer primary key,nom_projet text,nom_agent text,nom_zone text,nom_form text,data json ,zone json)', [],

                        function(tx, result) {
                        },
                        function(error) {
                            alert("Error occurred while creating the table.");
                        });
                });
            }
        });
    </script>

    <script>
        get_form();
    </script>
</body>

</html>