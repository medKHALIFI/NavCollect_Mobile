<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- jQuery -->
    <script src="plugins/jquery/dist/jquery.min.js"></script>
    <!-- Openlayers -->
    <link rel="stylesheet" href="plugins/ol/ol.css" />
    <script type="text/javascript" src="plugins/ol/ol.js"></script>
    <!-- Google Fonts  -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet" type="text/css">
    <!-- Bootstrap -->
    <link href="plugins/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <!-- NProgress -->
    <link href="plugins/nprogress/nprogress.css" rel="stylesheet">
    <!-- jQuery custom content scroller -->
    <link href="plugins/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.min.css" rel="stylesheet" />
    <!-- Waves Effect Css -->
    <link href="plugins/node-waves/waves.css" rel="stylesheet" />
    <!-- Animation Css -->
    <link href="plugins/animate-css/animate.css" rel="stylesheet" />
    <!-- Sweet Alert 2 Plugin Js -->
    <link href="plugins/SweetAlert2/sweetalert2.min.css" rel="stylesheet" />
    <!-- Sweet Alert 2 Plugin Js -->
    <script src="plugins/SweetAlert2/sweetalert2.min.js"></script>
    <!-- Datatables -->
    <link href="plugins/datatables.net-bs/css/dataTables.bootstrap.css" rel="stylesheet">
    <link href="plugins/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="plugins/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="plugins/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="plugins/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link href="css/custom.css" rel="stylesheet">

</head>

<body class="nav-md ">
    <div class="container body">
        <div class="main_container">
            <!-- top navigation -->
            <div class="navheader">
                <div class="col-sm-12" align="center">
                    <div class="row">
                        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4" style="margin-bottom: 10px"><img src="images/logo.png" alt="logo" style="width:110px; height:40px"></div>
                        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2"></div>
                        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2"></div>
                        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2"><button type="button" id="syncroniser" class="btn btn-circle bg-footer "><i class="fas fa-share-square"></i></button></div>
                        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2"><button type="button" class="btn btn-circle bg-footer" onclick="go_home()"><i class="fas fa-map-marked-alt"></i></button></div>
                    </div>
                </div>
            </div>
            <br>
            <!-- /top navigation -->

            <!-- page content -->
            <div class="right_col" role="main">
                <div class="">
                    <div class="page-title">
                    </div>
                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    Données collectées :
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <p class="text-muted font-13 m-b-30">

                                    </p>
                                    <div class="table-responsive">
                                        <table id="table_data" class="table">
                                            <thead>
                                                <tr>
                                                    <th>Projet</th>
                                                    <th>Agent </th>
                                                    <th>Zone d'étude</th>
                                                    <th>Formulaire</th>
                                                    <th>Données</th>
                                                    <th>Zones digitalisées</th>
                                                </tr>
                                            </thead>
                                            <tbody id="table_id">
                                                <tr>
                                                    <!-- Valeur par défaut  -->
                                                    <td>projet</td>
                                                    <td>agnet</td>
                                                    <td>zone</td>
                                                    <td>form</td>
                                                    <td><button type="button" id="102030" class="btn btn-circle bg-footer"><i class="fas fa-clipboard-list"></i></button></td>
                                                    <td><button type="button" class="btn btn-circle bg-footer"><i class="fas fa-clipboard-list"></i></button></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="row clearfix">
                                        <div class=".col-md-4 .col-md-offset-4">
                                            <div class="btn-group btn-group-justified" role="group" aria-label="...">
                                                <div class="btn-group" role="group">
                                                    <button id="delete_data" class="float-right btn bg-red" type="button"><i class="fas fa-trash"></i> &nbsp; Supprimer tous</button>
                                                </div>
                                                <div class="btn-group" role="group">
                                                    <button id="syncroniser" class="float-left btn bg-green" type="button"><i class="fas fa-share-square"></i>&nbsp; Synchroniser</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /page content -->
        </div>
    </div>

    <!-- Modal : Zone digitalisée -->
    <div class="modal animated fadeInDown" id="modal-previewZone">
        <div class="vertical-alignment-helper">
            <div class="modal-dialog vertical-align-center" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="exampleModalLabel">Zone que vous avez digitalisé </h4>
                    </div>
                    <div class="modal-body" id="modal-body-zone">

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal : visualisation des données collectées -->
    <div class="modal animated fadeInDown" id="modal-previewData" role="dialog">
        <div class="vertical-alignment-helper">
            <div class="modal-dialog vertical-align-center" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="exampleModalLabel">Données collectées </h4>
                    </div>
                    <div class="modal-body" id="bodyPreviewform">
                        <div class="table-responsive" id="table_donnee"></div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
    </script>


    <!-- Datatables-->
    <script src="plugins/datatables.net/js/jquery.dataTables.js"></script>
    <script src="plugins/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="plugins/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="plugins/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="plugins/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="plugins/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="plugins/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="plugins/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="plugins/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="plugins/pdfmake/build/vfs_fonts.js"></script>
    <!-- Bootstrap -->
    <script src="plugins/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="plugins/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="plugins/nprogress/nprogress.js"></script>
    <!-- jQuery custom content scroller -->
    <script src="plugins/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="js/custom.js"></script>
    <!-- Waves Effect Plugin Js -->
    <script src="plugins/node-waves/waves.js"></script>
    <!-- Select Plugin Js -->
    <script src="plugins/bootstrap-select/js/bootstrap-select.js"></script>
    <!-- Sweet Alert 2 Plugin Js -->
    <script src="plugins/SweetAlert2/sweetalert2.min.js"></script>
    <!-- Cordova -->
    <script src="cordova.js"></script>

    <script>
        $(document).ready(function() {
            //   $('#example').DataTable();
        });
    </script>

    <!-- ouvrir la base de donnee-->
    <!-- sqlite 
    <script src="js/sqlite.js"></script>-->



    <!-- script de test des modals-->
    <script>
        function preview_zone() {
            alert("modal preview zone");

        };
        /*
                $("#102030").click(function() {
                    alert("modal preview zone");

                });*/
    </script>

    <!-- recuperation des donnees dans la base de donnees -->
    <script>
        function go_home() {
            url = 'index.html';
            location.replace(url);
        }
        $(document).ready(function() {
            console.log("document ready ;) ");



            setTimeout(function() {
                $('#table_data').addClass("table-bordered table-striped table-hover dt-responsive display nowrap jambo_table");
                $('#table_data').DataTable();
            }, 1000);

            var myDB;
            /*  $("#102030").click(function() {
                  alert("modal preview zone");

              });*/
            //Open Database Connection
            document.addEventListener("deviceready", onDeviceReady, false);

            function onDeviceReady() {
                myDB = window.sqlitePlugin.openDatabase({
                    name: "mySQLite.db",
                    location: 'default'
                });

                $("#table_id").html("");
                myDB.transaction(function(transaction) {
                    transaction.executeSql('SELECT * FROM data', [], function(tx, results) {
                        var len = results.rows.length,
                            i;
                        //results.rows.item(i).data
                        //results.rows.item(i).zone
                        for (i = 0; i < len; i++) {
                            $("#table_id").append("<tr><td>" + results.rows.item(i).nom_projet + "</td><td>" + results.rows.item(i).nom_agent + "</td><td>" + results.rows.item(i).nom_zone + "</td><td>" + results.rows.item(i).nom_form + "</td><td><button type='button' id='" + results.rows.item(i).id + "' class='classe_viewdata btn btn-circle bg-footer'><i class='fas fa-clipboard-list'></i></button></td><td><button type='button'  id='" + results.rows.item(i).id + "' class='classe_viewzone btn btn-circle bg-footer'><i class='fas fa-map'></i></button></td> ");
                        }
                    }, null);

                });
            }
            //Delete Data from Database

            $(document.body).on('click', '.classe_viewzone', function() {
                //console.log("hellow" + this.id);

                var id = this.id;
                myDB.transaction(function(transaction) {
                    transaction.executeSql('SELECT * FROM data', [], function(tx, results) {
                        var len = results.rows.length,
                            i;
                        //results.rows.item(i).data
                        //results.rows.item(i).zone
                        for (i = 0; i < len; i++) {
                            if (id == results.rows.item(i).id) {

                                // alert("zone" + results.rows.item(i).zone);

                                $("#modal-previewZone").modal();
                                $('#modal-body-zone').html('<div id="map1" class="map1"></div>');

                                //    $('#modal-body-zone').append(results.rows.item(i).zone);

                                //  alert("geojson  : " + results.rows.item(i).zone);


                                var osm1 = new ol.layer.Tile({
                                    title: "Open Streets Map",
                                    baseLayer: true,
                                    source: new ol.source.OSM(),
                                    visible: true
                                });



                                var map1 = new ol.Map({
                                    layers: [osm1],
                                    target: 'map1',
                                    controls: ol.control.defaults({
                                        attribution: false,
                                        zoom: false
                                    }).extend([
                                        new ol.control.ScaleLine()
                                    ]),

                                    view: new ol.View({
                                        center: [0, 0],
                                        zoom: 2
                                    })

                                });

                                console.log(results.rows.item(i).zone);
                                var geojson_zone = new ol.layer.Vector({
                                    title: nom_zone,
                                    timeInfo: null,
                                    isSelectable: true,
                                    source: new ol.source.Vector({
                                        features: new ol.format.GeoJSON().readFeatures(results.rows.item(i).zone)
                                    }),
                                    style: style_zone,
                                });
                                map1.addLayer(geojson_zone);

                                var extent = geojson_zone.getSource().getExtent();
                                map1.getView().fit(extent, map1.getSize());

                            }

                        }
                    }, null);

                });
            });
            $(document.body).on('click', '.classe_viewdata', function() {
                console.log("hellow" + this.id);

                var id = this.id;
                myDB.transaction(function(transaction) {
                    transaction.executeSql('SELECT * FROM data', [], function(tx, results) {
                        var len = results.rows.length,
                            i;
                        //results.rows.item(i).data
                        //results.rows.item(i).zone
                        for (i = 0; i < len; i++) {
                            if (id == results.rows.item(i).id) {
                                // alert("data" + results.rows.item(i).data);
                                $("#modal-previewData").modal();
                                $('#bodyPreviewform').html(results.rows.item(i).data);


                                $("#bodyPreviewform").on('shown.bs.modal', function() {
                                    var data = JSON.parse(results.rows.item(i).data);

                                    // CODE DE JSON 2 HTML TABLE:
                                    document.getElementById('table_donnee').innerHTML = json2table(data, 'table table-bordered table-striped jambo_table table-hover dataTable data');
                                    ExportTable();

                                    // JSON DATA 2 HTML TABLE
                                    function json2table(json, classes) {
                                        var cols = Object.keys(json[0]);

                                        var headerRow = '';
                                        var bodyRows = '';

                                        classes = classes || '';

                                        function capitalizeFirstLetter(string) {
                                            return string.charAt(0).toUpperCase() + string.slice(1);
                                        }

                                        cols.map(function(col) {
                                            headerRow += '<th>' + capitalizeFirstLetter(col) + '</th>';
                                        });

                                        json.map(function(row) {
                                            bodyRows += '<tr>';

                                            cols.map(function(colName) {
                                                bodyRows += '<td>' + row[colName] + '</td>';
                                            })

                                            bodyRows += '</tr>';
                                        });

                                        return '<table class="' +
                                            classes +
                                            '"><thead><tr>' +
                                            headerRow +
                                            '</tr></thead><tbody>' +
                                            bodyRows +
                                            '</tbody></table>';
                                    }


                                    // EXPORT
                                    function ExportTable() {
                                        $(".data").tableExport({
                                            headings: true,
                                            footers: true,
                                            formats: ["xls", "csv", "txt"],
                                            fileName: "id",
                                            bootstrap: true,
                                            position: "well",
                                            ignoreRows: null,
                                            ignoreCols: null,
                                            ignoreCSS: ".tableexport-ignore"
                                        });
                                    }


                                });
                            }

                        }
                    }, null);

                });
            });
            $("#delete_data").click(function() {

                myDB.transaction(function(transaction) {
                    var executeQuery = "DROP TABLE  IF EXISTS data";
                    transaction.executeSql(executeQuery, [],
                        function(tx, result) {
                            swal({
                                position: 'top-end',
                                type: 'success',
                                title: 'Table deleted successfully.',
                                showConfirmButton: false,
                                timer: 1500
                            })
                        },
                        function(error) {
                            alert('Error occurred while droping the table.');
                        }
                    );
                });
                setTimeout(function() {

                    url = 'data.html';

                    location.replace(url);

                }, 500);

            });

            $("#syncroniser").click(function() {
                myDB.transaction(function(transaction) {
                    transaction.executeSql('SELECT * FROM data', [], function(tx, results) {
                        var len = results.rows.length,
                            i;
                        var id;
                        var supprimer_sqlite = [];
                        for (i = 0; i < len; i++) {
                            id = results.rows.item(i).id;
                            $.ajax({
                                type: 'POST',
                                async: false,
                                url: 'http://192.168.1.199/php/add_data.php',
                                data: {
                                    'nom_projet': results.rows.item(i).nom_projet,
                                    'nom_agent': results.rows.item(i).nom_agent,
                                    'nom_zone': results.rows.item(i).nom_zone,
                                    'nom_form': results.rows.item(i).nom_form,
                                    'data': results.rows.item(i).data,
                                    'zone': results.rows.item(i).zone
                                },
                                beforeSend: function() {

                                },
                                success: function(response) {
                                    if (response == 2) {
                                        supprimer_sqlite.push(id);


                                    } else {
                                        alert("erreur");
                                    }
                                }
                            });
                        }

                        supprimer_sqlite.forEach(function(i) {
                            var idx = i;

                            myDB.transaction(function(transaction) {
                                var executeQuery = "DELETE FROM data where id=?";
                                transaction.executeSql(executeQuery, [idx],
                                    function(tx, result) {

                                    },
                                    function(error) {
                                        alert('Something went Wrong');
                                    });
                            });

                        })
                    }, null);
                });


                swal({
                    title: 'Synchronisation',
                    text: "Vos données sont bien syncronisées !",
                    type: 'success',
                    showCancelButton: false,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'oky!'
                }).then((result) => {
                    if (result.value) {
                        setTimeout(
                            function() {
                                url = 'data.html';
                                location.replace(url);
                            },
                            100);
                    }
                })


            });

        });
    </script>

</body>


</html>